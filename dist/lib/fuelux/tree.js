/*
 * Fuel UX Tree
 * https://github.com/ExactTarget/fuelux
 *
 * Copyright (c) 2012 ExactTarget
 * Licensed under the MIT license.
 */

define(["require","jquery"],function(e){var t=e("jquery"),n=function(e,n){this.$element=t(e),this.options=t.extend({},t.fn.tree.defaults,n),this.$element.on("click",".tree-item",t.proxy(function(e){this.selectItem(e.currentTarget)},this)),this.$element.on("click",".tree-folder-header",t.proxy(function(e){this.selectFolder(e.currentTarget)},this)),this.render()};n.prototype={constructor:n,render:function(){this.populate(this.$element)},populate:function(e){var n=this,r=e.parent(),i=r.find(".tree-loader:eq(0)");i.show(),this.options.dataSource.data(e.data(),function(s){i.hide(),t.each(s.data,function(i,s){var o;s.type==="folder"?(o=n.$element.find(".tree-folder:eq(0)").clone().show(),o.find(".tree-folder-name").html(s.name),o.find(".tree-loader").html(n.options.loadingHTML),o.find(".tree-folder-header").data(s)):s.type==="item"&&(o=n.$element.find(".tree-item:eq(0)").clone().show(),o.find(".tree-item-name").html(s.name),o.data(s));var u=s.dataAttributes||[];t.each(u,function(e,t){switch(e){case"class":case"classes":case"className":o.addClass(t);break;default:o.attr(e,t)}}),e.hasClass("tree-folder-header")?r.find(".tree-folder-content:eq(0)").append(o):e.append(o)}),n.$element.trigger("loaded",r)})},selectItem:function(e){var n=t(e),r=this.$element.find(".tree-selected"),i=[];this.options.multiSelect?t.each(r,function(e,r){var s=t(r);s[0]!==n[0]&&i.push(t(r).data())}):r[0]!==n[0]&&(r.removeClass("tree-selected").find("i").removeClass("icon-ok").addClass("tree-dot"),i.push(n.data()));var s="selected";n.hasClass("tree-selected")?(s="unselected",n.removeClass("tree-selected"),n.find("i").removeClass("icon-ok").addClass("tree-dot")):(n.addClass("tree-selected"),n.find("i").removeClass("tree-dot").addClass("icon-ok"),this.options.multiSelect&&i.push(n.data())),i.length&&this.$element.trigger("selected",{info:i}),n.trigger("updated",{info:i,item:n,eventType:s})},selectFolder:function(e){var n=t(e),r=n.parent(),i=r.find(".tree-folder-content"),s=i.eq(0),o,u,a;n.find(".icon-folder-close").length?(o="opened",u=".icon-folder-close",a="icon-folder-open",s.show(),i.children().length||this.populate(n)):(o="closed",u=".icon-folder-open",a="icon-folder-close",s.hide(),this.options.cacheItems||s.empty()),r.find(u).eq(0).removeClass("icon-folder-close icon-folder-open").addClass(a),this.$element.trigger(o,n.data())},selectedItems:function(){var e=this.$element.find(".tree-selected"),n=[];return t.each(e,function(e,r){n.push(t(r).data())}),n},collapse:function(){var e=this.options.cacheItems;this.$element.find(".icon-folder-open").each(function(){var n=t(this).removeClass("icon-folder-close icon-folder-open").addClass("icon-folder-close"),r=n.parent().parent(),i=r.children(".tree-folder-content");i.hide(),e||i.empty()})}},t.fn.tree=function(e,r){var i,s=this.each(function(){var s=t(this),o=s.data("tree"),u=typeof e=="object"&&e;o||s.data("tree",o=new n(this,u)),typeof e=="string"&&(i=o[e](r))});return i===undefined?s:i},t.fn.tree.defaults={multiSelect:!1,loadingHTML:"<div>Loading...</div>",cacheItems:!0},t.fn.tree.Constructor=n});